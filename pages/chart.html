<!doctype html>
<html>

<head>
	<title>Line Chart</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script>
	<script src="http://www.chartjs.org/samples/latest/utils.js"></script>
	<style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>

	<link rel="stylesheet" type="text/css" href="chart.css">
</head>

<body>
	<nav class="navbar">
		<p id ="title" >DinnerDash</p>
	</nav>
	<div class = "rower">
		<div id ="bubble">
			<h3> TIME </h3>
			<p id="time"> 15:30 </p>
		</div>
		<div id ="bubbler">
			<h3>EXPECTED NUMBER OF PEOPLE </h3>
			<p id="label"> max </p> <p id="maxNum"> 880 </p>
			<p id="label"> min </p> <p id="minNum"> 660 </p>
		</div>
	</div>

	<div style=" width:80%;">
		<canvas id="canvas" style=" padding:10px; margin-left:3%; margin-top: 50px; background-color: white; border-radius: 5px;"></canvas>
	</div>
	<br>
	<br>
	<script>
		document.getElementById('title').addEventListener('click', function() {
				window.location = "http://0.0.0.0:5000";
		});

		var timeFormat = 'HH:mm';
		function newTime(mins) {
			return moment("20130208T1730").add(mins, 'm').format("HH:mm");
		}
		function newDateString(days) {
			return moment().add(days, 'd').format(timeFormat);
		}
		var color = Chart.helpers.color;
		var config = {
			type: 'line',
			data: {
				labels: [ // Date Objects
				],
				datasets: [{
					label: 'Number Of Diners',
					backgroundColor: 'rgba(0, 73, 156, 0.5)',
					borderColor: 'rgba(0, 73, 156, 1)',
					fill: false,
					data: [
					],
				}]
			},
			options: {
				title: {
					text: 'Chart.js Time Scale'
				},
				scales: {
					xAxes: [{
						type: 'time',
						time: {
							format: timeFormat,
							// round: 'day'
							tooltipFormat: 'll HH:mm'
						},
						scaleLabel: {
							display: true,
							labelString: 'Time'
						},
						ticks: {
							min: "15:30"
						}
					}],
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: 'value',
						},
						ticks: {
							beginAtZero: true
						}
					}]
				},
			}
		};
		function getValueAtTime(time, total_people){ //time format: (int) 1730.... 2130
			var op = Math.floor(((time - 1730)/50) + 1);
			console.log(op);
			var ppl = 0;
			switch (op){
				case 1:
					ppl = getRandomInt(80, 120); // 530pm 10
					break;
				case 2:
					ppl = getRandomInt(150, 170); // 6pm 15
					break;
				case 3:
					ppl = getRandomInt(230, 260); // 630pm 25
					break;
				case 4:
					ppl = getRandomInt(140, 150); // 7pm  15
					break;
				case 5:
					ppl = getRandomInt(80, 110); // 730pm  10
					break;
				case 6:
					ppl = getRandomInt(80, 100); // 8pm  15
					break;
				case 7:
					ppl = getRandomInt(30, 90); // 830pm 5
					break;
				case 8:
					ppl = getRandomInt(30, 80); // 9pm  5
					break;
				case 9:
					ppl = 0;
					break;
			}
			return Math.floor(((ppl * total_people) / 1000));
		}
		function getRandomInt(min, max) {

			if (dayOfWeek == 1 || dayOfWeek == 3 || dayOfWeek == 5) {
				return Math.min((Math.floor(Math.random() * (max - min + 1)) + min)*0.9, 140);

			} else {
				return Math.min((Math.floor(Math.random() * (max - min + 1)) + min)*1.1,140);
			}

		}
		window.onload = function() {
			var ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);
		};

		function addData(time, people) {
			baseTime = 1730;
			if (time % 100 == 0){
				var i = ((time - baseTime - 70) / 50) + 1
			} else {
				var i = (time - baseTime) / 50;
			}
			if (config.data.datasets.length > 0) {
				config.data.labels.push(newTime(i * 30));
				for (var index = 0; index < config.data.datasets.length; ++index) {
					if (typeof config.data.datasets[index].data[0] === 'object') {
						var h = getValueAtTime(time, people);
						console.log(h);
						config.data.datasets[index].data.push({
							y: h
						});
					} else {
						var h = getValueAtTime(time, people);
						console.log(h);
						config.data.datasets[index].data.push(getValueAtTime(time, people));
					}
				}
				// window.myLine.update();
			}
			return h;
		};
		var parameters = location.search.substring(1).split("&");
	    var ppltemp = parameters[0].split("=");
		var timesplit = (parameters[1].split("="))[1].split(":");
		var hours = ((parseInt(timesplit[0]) + 12) * 100) + parseInt(timesplit[1]);
		var daysplit = ((parameters[2].split("="))[1].split(","));
		var dayOfWeek = parseInt(daysplit[2]);

		console.log("hours = " + hours % 100);
		if(0 < (hours % 100) && (hours % 100) < 30) {
			console.log("first");
			hours -= hours % 100;
		} else if (30 < (hours % 100) && (hours % 100) < 100){
			console.log("second");
			hours += 100 - (hours % 100);
		}
		var count = 1;
		console.log("hours = " + hours);
		var time = hours;
		var total = 0;
		while(time < 2131){
			console.log("time=" + time);
			if(hours < 1901){
				total += addData(time, parseInt(ppltemp[1]) * 4);
			} else {
				total += addData(time, parseInt(ppltemp[1]));
			}
			if(time % 100 == 0){
				time += 30;
			} else {
				time += 70;
			}
			count++;
		}

		console.log(total);
		document.getElementById("time").innerHTML = (parseInt(timesplit[0]) + 12) + ":" + timesplit[1];
		if(hours < 1901){
			document.getElementById("minNum").innerHTML = Math.round(0.95 * total);
			document.getElementById("maxNum").innerHTML = Math.round(1.05 * total);
		} else {
			document.getElementById("minNum").innerHTML = Math.round(0.95 * total);
			document.getElementById("maxNum").innerHTML = Math.round(1.05 * total);
		}

	</script>
</body>

</html>
